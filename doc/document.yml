openapi: 3.0.0
info:
  title: Authentication, Cars, and Categories API
  description: API for user authentication, car management, and category management, including registration, verification, login, logout, password reset, user retrieval, and CRUD operations for cars and categories.
  version: 1.0.0
servers:
  - url: http://localhost:3000
    description: Local development server
paths:
  /register:
    post:
      summary: Register a new user
      description: Registers a new user with email and password, generates an OTP for verification.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Bad request (e.g., user already exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /verify:
    post:
      summary: Verify user with OTP
      description: Verifies a user by checking the provided OTP against the stored OTP.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
      responses:
        '201':
          description: User verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyResponse'
        '400':
          description: Bad request (e.g., OTP expired or invalid)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /login:
    post:
      summary: Log in a user
      description: Authenticates a user and returns access and refresh tokens.
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '201':
          description: Login successful, tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Bad request (e.g., wrong password)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (e.g., user not verified)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /logOut:
    get:
      summary: Log out a user
      description: Clears access and refresh tokens from cookies.
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '201':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /resetPassword:
    post:
      summary: Reset user password
      description: Resets the password for a verified user.
      tags:
        - Authentication
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '201':
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResetPasswordResponse'
        '401':
          description: Unauthorized (e.g., user not verified)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /refreshToken:
    get:
      summary: Refresh access token
      description: Generates a new access token using a refresh token.
      tags:
        - Authentication
      security:
        - cookieAuth: []
      responses:
        '200':
          description: New access token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: New access token generated
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/{id}:
    get:
      summary: Get user details
      description: Retrieves user details by ID, including categories and cars for non-user roles.
      tags:
        - User
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: User details retrieved successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/UserResponse'
                  - $ref: '#/components/schemas/AdminUserResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /cars:
    get:
      summary: Get all cars
      description: Retrieves a list of all cars.
      tags:
        - Cars
      security:
        - cookieAuth: []
      responses:
        '200':
          description: List of cars retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Car'
    post:
      summary: Create a new car
      description: Creates a new car entry (admin only). Requires file uploads for frontImage, backImage, and modelImage.
      tags:
        - Cars
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CarCreateRequest'
      responses:
        '201':
          description: Car created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarCreateResponse'
        '400':
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /cars/{id}:
    get:
      summary: Get a single car
      description: Retrieves details of a specific car by ID.
      tags:
        - Cars
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Car ID
      responses:
        '200':
          description: Car retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarGetResponse'
        '404':
          description: Car not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update a car
      description: Updates an existing car entry (admin only). File uploads are optional.
      tags:
        - Cars
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Car ID
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CarUpdateRequest'
      responses:
        '200':
          description: Car updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarUpdateResponse'
        '400':
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Car or token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete a car
      description: Deletes a car entry (admin only).
      tags:
        - Cars
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Car ID
      responses:
        '200':
          description: Car deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CarDeleteResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Car or token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /category:
    get:
      summary: Get all categories
      description: Retrieves a list of all categories.
      tags:
        - Categories
      security:
        - cookieAuth: []
      responses:
        '200':
          description: List of categories retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items:
                      $ref: '#/components/schemas/Category'
    post:
      summary: Create a new category
      description: Creates a new category (admin only). Requires an image file upload.
      tags:
        - Categories
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CategoryCreateRequest'
      responses:
        '201':
          description: Category created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryCreateResponse'
        '400':
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /category/{id}:
    get:
      summary: Get a single category
      description: Retrieves details of a specific category by ID, including associated cars.
      tags:
        - Categories
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Category retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryGetResponse'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update a category
      description: Updates an existing category (admin only). Image upload is optional.
      tags:
        - Categories
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CategoryUpdateRequest'
      responses:
        '200':
          description: Category updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryUpdateResponse'
        '400':
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Category or token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete a category
      description: Deletes a category (admin only).
      tags:
        - Categories
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Category ID
      responses:
        '200':
          description: Category deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryDeleteResponse'
        '401':
          description: Unauthorized (e.g., not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Category or token not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: AccessToken
  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: Password123!
        role:
          type: string
          enum: [user, admin]
          default: user
        isVerified:
          type: boolean
          default: false
    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          example: registered
        user:
          type: object
          properties:
            email:
              type: string
              example: user@example.com
            otp:
              type: string
              example: "123456"
            otpTime:
              type: integer
              example: 1698076800000
    VerifyRequest:
      type: object
      required:
        - email
        - otp
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        otp:
          type: string
          example: "123456"
    VerifyResponse:
      type: object
      properties:
        message:
          type: string
          example: verify
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: Password123!
    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: success
        access:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    LogoutResponse:
      type: object
      properties:
        message:
          type: string
          example: log out
    ResetPasswordRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: NewPassword123!
    ResetPasswordResponse:
      type: object
      properties:
        message:
          type: string
          example: reset password success
    UserResponse:
      type: object
      properties:
        _id:
          type: string
          example: 507f1f77bcf86cd799439011
        email:
          type: string
          example: user@example.com
        role:
          type: string
          example: user
        createdAt:
          type: string
          format: date-time
          example: 2023-10-23T12:00:00Z
    AdminUserResponse:
      type: object
      properties:
        _id:
          type: string
          example: 507f1f77bcf86cd799439011
        email:
          type: string
          example: user@example.com
        role:
          type: string
          example: admin
        createdAt:
          type: string
          format: date-time
          example: 2023-10-23T12:00:00Z
        category:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        cars:
          type: array
          items:
            $ref: '#/components/schemas/Car'
    Car:
      type: object
      properties:
        _id:
          type: string
          example: 507f1f77bcf86cd799439012
        brand:
          type: string
          example: Toyota
        model:
          type: string
          example: Camry
        year:
          type: integer
          example: 2020
        motor:
          type: string
          example: 2.5L
        color:
          type: string
          example: Blue
        distance:
          type: integer
          example: 50000
        gearbox:
          type: string
          example: Automatic
        price:
          type: number
          example: 25000
        frontImage:
          type: string
          example: front.jpg
        backImage:
          type: string
          example: back.jpg
        modelImage:
          type: string
          example: model.jpg
        description:
          type: string
          example: A well-maintained sedan with low mileage.
        owner_id:
          type: string
          example: 507f1f77bcf86cd799439011
        category_id:
          type: string
          example: 507f1f77bcf86cd799439013
    CarCreateRequest:
      type: object
      required:
        - brand
        - model
        - year
        - motor
        - color
        - distance
        - gearbox
        - price
        - description
        - owner_id
        - category_id
        - frontImage
        - backImage
        - modelImage
      properties:
        brand:
          type: string
          example: Toyota
        model:
          type: string
          example: Camry
        year:
          type: integer
          example: 2020
        motor:
          type: string
          example: 2.5L
        color:
          type: string
          example: Blue
        distance:
          type: integer
          example: 50000
        gearbox:
          type: string
          example: Automatic
        price:
          type: number
          example: 25000
        description:
          type: string
          example: A well-maintained sedan with low mileage.
        owner_id:
          type: string
          example: 507f1f77bcf86cd799439011
        category_id:
          type: string
          example: 507f1f77bcf86cd799439013
        frontImage:
          type: string
          format: binary
        backImage:
          type: string
          format: binary
        modelImage:
          type: string
          format: binary
    CarCreateResponse:
      type: object
      properties:
        message:
          type: string
          example: Careated
    CarGetResponse:
      type: object
      properties:
        message:
          type: string
          example: Car retrieved successfully
    CarUpdateRequest:
      type: object
      required:
        - brand
        - model
        - year
        - motor
        - color
        - distance
        - gearbox
        - price
        - description
        - owner_id
      properties:
        brand:
          type: string
          example: Toyota
        model:
          type: string
          example: Camry
        year:
          type: integer
          example: 2020
        motor:
          type: string
          example: 2.5L
        color:
          type: string
          example: Blue
        distance:
          type: integer
          example: 50000
        gearbox:
          type: string
          example: Automatic
        price:
          type: number
          example: 25000
        description:
          type: string
          example: A well-maintained sedan with low mileage.
        owner_id:
          type: string
          example: 507f1f77bcf86cd799439011
        frontImage:
          type: string
          format: binary
        backImage:
          type: string
          format: binary
        modelImage:
          type: string
          format: binary
    CarUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Car updated
    CarDeleteResponse:
      type: object
      properties:
        message:
          type: string
          example: Car deleted
    Category:
      type: object
      properties:
        _id:
          type: string
          example: 507f1f77bcf86cd799439013
        name:
          type: string
          example: Sedan
        img:
          type: string
          example: category.jpg
        owner_id:
          type: string
          example: 507f1f77bcf86cd799439011
        cars:
          type: array
          items:
            $ref: '#/components/schemas/Car'
    CategoryCreateRequest:
      type: object
      required:
        - name
        - owner_id
        - img
      properties:
        name:
          type: string
          example: Sedan
        owner_id:
          type: string
          example: 507f1f77bcf86cd799439011
        img:
          type: string
          format: binary
    CategoryCreateResponse:
      type: object
      properties:
        message:
          type: string
          example: Category created
    CategoryGetResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Category'
    CategoryUpdateRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: Sedan
        img:
          type: string
          format: binary
    CategoryUpdateResponse:
      type: object
      properties:
        message:
          type: string
          example: Category updated
    CategoryDeleteResponse:
      type: object
      properties:
        message:
          type: string
          example: Category deleted
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Error message